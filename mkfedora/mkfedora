#!/bin/sh

mkdir -p /tmp/mkfedora
cd /tmp/mkfedora

# dnf install xorriso squashfs-tools isomd5sum
# curl -o official.iso https://mirror.23m.com/fedora/linux/development/39/Workstation/x86_64/iso/Fedora-Workstation-Live-x86_64-39-20230920.n.0.iso
ln -s /run/media/kkocdko/data/boot.iso official.iso
if [ ! -e squashfs-root/LiveOS/rootfs.img ]; then
  mkdir official-iso
  mount -r official.iso official-iso
  unsquashfs official-iso/LiveOS/squashfs.img
  umount official-iso
  rm -rf official-iso
  chmod -w squashfs-root/LiveOS/rootfs.img
fi
mkdir rootfs-img out out-u out-w
mount -r squashfs-root/LiveOS/rootfs.img rootfs-img
mount -t overlay overlay -o lowerdir=rootfs-img,upperdir=out-u,workdir=out-w out

cat <<EOF | chroot out /bin/bash
# then run inner chroot
dnf mark install git-core tmux
dnf remove -y \
  firefox libreoffice-* gstreamer1-plugin-libav qemu-* podman abrt plymouth \
  xorg-x11-server-Xorg gnome-shell-extension-* qt5-* qt6-* \
  gnome-software gnome-remote-desktop gnome-connections gnome-browser-connector gnome-calendar gnome-clocks gnome-contacts gnome-weather gnome-tour gnome-user-docs gnome-characters gnome-maps gnome-logs gnome-font-viewer gnome-calculator totem baobab loupe cheese evince rhythmbox simple-scan \
  git nano cpp sos orca paps opensc toolbox tcpdump traceroute binutils uresourced whois words dnsmasq python-systemd-doc system-config-printer-* libsane-* evince-* gamemode geolite2-* langpacks-* glibc-all-langpacks glibc-langpack-en hunspell-en-GB \
  gnome-backgrounds desktop-backgrounds-gnome fedora-workstation-backgrounds fedora-bookmarks fedora-flathub-remote fedora-logos-httpd fedora-chromium-* \
  ibus-anthy ibus-hangul ibus-libzhuyin ibus-m17n ibus-typing-booster \
  default-fonts-core-math default-fonts-core-emoji default-fonts-other-* urw-base35-*
# anaconda-install-env-deps
rm -rf /var/lib/dnf/* /var/lib/selinux/targeted/active/modules/*
rm -rf /usr/share/ibus/dicts/emoji-*
EOF
cat <<EOF >out/usr/share/anaconda/gnome/fedora-welcome
#!/bin/sh
gsettings set org.gnome.settings-daemon.plugins.power idle-brightness 100 # 无操作不降亮度
gsettings set org.gnome.desktop.interface cursor-blink false # 关闭光标 blink
gsettings set org.gnome.mutter check-alive-timeout 7200000 # 弹出 not responsing 时间，单位 ms；勿设为 0 否则会出现 bug
gsettings set org.gnome.shell disable-user-extensions false # 启用用户扩展
gsettings set org.gnome.desktop.peripherals.touchpad tap-to-click true
gsettings set org.gnome.desktop.background primary-color "#000000"
gsettings set org.gnome.desktop.wm.preferences titlebar-font "Noto Sans Bold 11"
gsettings set org.gnome.desktop.interface gtk-theme "adw-gtk3"
gsettings set org.gnome.desktop.interface font-name "Noto Sans 11"
gsettings set org.gnome.desktop.interface document-font-name "Noto Sans 11"
gsettings set org.gnome.desktop.interface monospace-font-name "Noto Sans Mono 10"
gsettings set org.gnome.TextEditor spellcheck false
rm -f /usr/share/applications/org.fedoraproject.welcome-screen.desktop
# systemctl disable dnf-makecache.service
# systemctl disable dnf-makecache.timer
EOF

[ ! -e adw-gtk3.tar.xz ] && curl -o adw-gtk3.tar.xz -L https://github.com/lassekongo83/adw-gtk3/releases/download/v4.9/adw-gtk3v4-9.tar.xz
tar -xf adw-gtk3.tar.xz -C out/usr/share/themes/

# dd if=/dev/zero of=rootfs.img bs=1M count=8192
# mkfs.ext4 rootfs.img -L Anaconda -b 4096 -m 0
# mkdir out-rootfs-img
# mount -o loop rootfs.img out-rootfs-img
# cp -a out out-rootfs-img
# umount out-rootfs-img
# sync
# mkdir out-rootfs-img/LiveOS
# mv rootfs.img out-rootfs-img/LiveOS/rootfs.img
# mksquashfs out-rootfs-img out.img -comp zstd -Xcompression-level 1
# rm -rf out-rootfs-img
# sync

# mksquashfs out out.img -no-duplicates -no-sparse -not-reproducible -no-recovery -comp lz4 # fast, for debug
mksquashfs out out.img -no-recovery -b 1M -comp zstd -Xcompression-level 22
umount out rootfs-img
rm -rf out-w out-u out rootfs-img

rm -rf out.iso
xorriso -indev official.iso -outdev out.iso -boot_image isolinux keep -pathspecs on -add /LiveOS/squashfs.img=out.img # -boot_image any keep
rm -rf out.img
implantisomd5 out.iso

qemu-system-x86_64 -machine q35,accel=kvm -device qemu-xhci -device usb-tablet -cpu host -smp 4 -m 4G -cdrom out.iso
