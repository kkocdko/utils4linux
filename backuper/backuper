#!/bin/sh
alias dusort="du -ad 1 2>/dev/null | sort -n"
alias 7z="~/misc/apps/7z"
if [ "$(id -u)" = "0" ]; then
echo "don't run as root please"
exit
fi

# My backup proposal:
# - The code dir backup with history, upload to cloud drive.
# - Other asserts like photo, software and more, phone and pc backup each other.

if [ "$1" = "pack-code-dir" ]; then
echo ">>> pack ~/misc/code directory"
rm -rf /tmp/bakcode/*
rsync --recursive --times --links --delete --filter=":- ~/misc/code/.rsyncignore" ~/misc/code /tmp/bakcode
password="7777"
slimname="code_$(date +%Y%m%d)_p$password"
# slimname="code_20181014-20231106_p$password"
cd /tmp/bakcode
# 7z a -p$password -mhe=on -mx -myx -mmt=off -ms=on -mtm=off -mtc=off -mta=off -mtr=off -m0=LZMA2:d=384m:fb=273 -mmc=1000000000 $slimname.7z archive
7z a -p$password -mhe=on $slimname.7z code
# 7z x -p7777 a.7z
exit
fi

if [ "$1" = "sync-from-phone" ]; then
echo ">>> sync from phone, please reconnect mtp before this to ensure the bcache cleared"
from_root="/run/user/1000/gvfs/mtp:host=LGE_LM-V409N_LMV409N1c42ce3d/Internal shared storage"
to_root="/run/media/kkocdko/data/backup/phone"
rsync_args="--progress --recursive --times --links --delete"
rsync $rsync_args "$from_root/Pictures/Screenshots" "$to_root/"
rsync $rsync_args "$from_root/DCIM" "$to_root/"
rsync $rsync_args "$from_root/DataBackup" "$to_root/"
exit
fi

if [ "$1" = "sync-to-phone" ]; then
echo ">>> sync to phone"
to_root="/run/user/1000/gvfs/mtp:host=LGE_LM-V409N_LMV409N1c42ce3d/Internal shared storage/pc"
/run/media/kkocdko/data
/home/kkocdko/misc/res
# /home/kkocdko/misc/apps
rsync --recursive --times --links --delete "/home/kkocdko/misc/apps" "$to_root/"
fi

echo "The backup script for kkocdko, see source code for usage and other info."
echo "Usage: $0 <command> [options]"

exit
mkdir -p dist
curl -o rclone.zip -L https://github.com/rclone/rclone/releases/download/v1.65.0/rclone-v1.65.0-linux-amd64.zip
unzip -p rclone.zip rclone-v1.65.0-linux-amd64/rclone > rclone
chmod +x rclone
rm -f rclone.zip
cd ..
./dist/rclone --config rclone.conf sync --progress ../proxy onedrive_kkocdko_163_com:/rclone/proxy
