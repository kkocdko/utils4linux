name: mksb.rsync
on:
  workflow_dispatch:
jobs:
  linux-x64:
    runs-on: ubuntu-22.04
    steps:
      - name: Build
        shell: sudo bash -e {0}
        run: |
          printf 'APT::Install-Recommends "false";\nAPT::Install-Suggests "false";\n' > /etc/apt/apt.conf.d/no-recommends-suggests ; rm -rf /etc/apt/sources.list /etc/apt/sources.list.d/* ; printf 'Types: deb\nURIs: http://azure.archive.ubuntu.com/ubuntu/\nSuites: jammy jammy-updates\nComponents: main\nTrusted: yes\n' > /etc/apt/sources.list.d/all.sources ; apt update
          apt install -y curl ca-certificates make zlib1g-dev libpopt-dev gcc g++ gawk autoconf automake acl libacl1-dev attr libattr1-dev libxxhash-dev libzstd-dev
          curl -L https://github.com/RsyncProject/rsync/archive/refs/tags/v3.3.0.tar.gz | tar -zx --strip-components 1
          (printf '#include <float.h>\n#include <stdlib.h>\n' ; cat popt/popt.c) > popt/popt.c.tmp ; mv popt/popt.c.tmp popt/popt.c
          export CFLAGS='-O2 -static -flto'
          ./configure --disable-lz4 --disable-openssl --disable-md2man --disable-debug
          make CFLAGS="$CFLAGS" -j$(nproc)
          strip rsync
          zip -9 linux-x64.zip rsync
      - name: Verify
        run: |
          ldd ./rsync || true
          ./rsync -V
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          body: "_"
          tag_name: "${{ 'mksb.rsync_3.3.0_' }}${{ github.run_id }}"
          files: linux-x64.zip
  linux-arm64:
    runs-on: ubuntu-22.04
    steps:
      - name: Build
        shell: sudo bash -e {0}
        run: |
          curl -o libzstd-dev_arm64.deb -L http://ftp.debian.org/debian/pool/main/libz/libzstd/libzstd-dev_1.5.4+dfsg2-5_arm64.deb ; dpkg -x ./libzstd-dev_arm64.deb / # https://packages.debian.org/stable/libzstd-dev
          curl -o libxxhash-dev_arm64.deb -L http://ftp.debian.org/debian/pool/main/x/xxhash/libxxhash-dev_0.8.1-1_arm64.deb ; dpkg -x ./libxxhash-dev_arm64.deb /
          printf 'APT::Install-Recommends "false";\nAPT::Install-Suggests "false";\n' > /etc/apt/apt.conf.d/no-recommends-suggests ; rm -rf /etc/apt/sources.list /etc/apt/sources.list.d/* ; printf 'Types: deb\nURIs: http://azure.archive.ubuntu.com/ubuntu/\nSuites: jammy jammy-updates\nComponents: main\nTrusted: yes\n' > /etc/apt/sources.list.d/all.sources ; apt update
          apt install -y g++-11-aarch64-linux-gnu
          apt install -y curl ca-certificates make zlib1g-dev libpopt-dev gcc g++ gawk autoconf automake acl libacl1-dev attr libattr1-dev libxxhash-dev libzstd-dev
          curl -L https://github.com/RsyncProject/rsync/archive/refs/tags/v3.3.0.tar.gz | tar -zx --strip-components 1
          curl -L https://github.com/rpm-software-management/popt/archive/1e7bc3883afe26c60c511bd4caf2f3c37803c06f.tar.gz | tar -zx --strip-components 1 -C popt ; mv popt/src/* popt/
          export CFLAGS='-O2 -static -flto -D PACKAGE=\"rsync\" -D POPT_SYSCONFDIR=\"/tmp\" -D HAVE_STRERROR -D X_OK=1' # X_OK=1 in unistd.h
          ./configure CC="aarch64-linux-gnu-gcc-11" --host aarch64 --disable-lz4 --disable-openssl --disable-md2man --disable-debug
          sed -i Makefile -e 's|popt_OBJS=|popt_OBJS=popt/poptint.o |'
          make CFLAGS="$CFLAGS" -j$(nproc) || true
          aarch64-linux-gnu-strip rsync
          zip -9 linux-arm64.zip rsync
      - name: Verify
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: bookworm
          dockerRunArgs: --volume "${PWD}:/workdir"
          run: |
            ldd /workdir/rsync || true
            /workdir/rsync -V
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          body: "_"
          tag_name: "${{ 'mksb.rsync_3.3.0_' }}${{ github.run_id }}"
          files: linux-arm64.zip
  win-x64:
    runs-on: windows-2022
    steps:
      - name: Build
        shell: C:\msys64\msys2_shell.cmd -defterm -here -no-start -e {0}
        run: |
          pacman -S --noconfirm libzstd-devel libxxhash-devel gcc zip autotools automake make
          curl -L https://github.com/Cyan4973/xxHash/archive/refs/tags/v0.8.2.tar.gz | tar -zx
          make -C xxHash-0.8.2 CC="gcc -O3 -static" -j$(nproc)
          mv xxHash-0.8.2/libxxhash.a /usr/lib/
          curl -L https://github.com/RsyncProject/rsync/archive/refs/tags/v3.3.0.tar.gz | tar -zx --strip-components 1 --exclude "*.test"
          ./configure --disable-lz4 --disable-openssl --disable-md2man --disable-debug
          make CC="gcc -static -O2" -j$(nproc) || true # no -flto
          strip rsync.exe
          mv /usr/bin/msys-2.0.dll ./
          zip -9 win-x64.zip rsync.exe msys-2.0.dll
      - name: Verify
        run: |
          ./rsync.exe -V
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          body: "_"
          tag_name: "${{ 'mksb.rsync_3.3.0_' }}${{ github.run_id }}"
          files: win-x64.zip
